## 第一天 区块链入门

### 比特币

#### 历史来源

去中心化的货币体系；金融危机刺激了比特币的发行；

加密技术、网络技术、共识算法；点对点的支付系统(P2P)；

比特币是C++以太坊是Go

原理：比特币转移后，不可以重复花费；交易不可伪造(密码学保证私钥公钥)；比特币可以分小(1比特币 = 10^8聪)；通过挖矿获取货币，谁挖出矿就是谁的；GPU比CPU计算力更强，所以使用GPU显卡挖矿。矿机+矿场+矿池(个人笔记本+分布式系统)；比特币不会通货膨胀，只会通货紧缩(如果秘钥丢失这部分货币就不能用了)

#### 拜占庭将军问题

问题：有n个组员，上面有一个主管，上面是老板。如果组员想弹劾主管，需要有大于50%的组员想老板反映主管的问题。特点：敌人很强大；组员都是独立的，不能互相干涉；组员行动一致才能成功；组员行动不一致就会失败。互联网中的拜占庭将军问题：世界各地的分布式节点如何对某些状态达到共识，知道网络中有一些不利因素（黑客），如何达到共识。

解决方法：数字签名、最长链机制、POW机制。

数字签名：每个将军都会对信息进行依次签名，如果签名的个数大于二分之n，就会确认信息真伪。实际上互联网上的分布式节点的数量不确定。

最长链机制：获取当时在线的所有签名链，最长的认为是真实的(如果是三分之n也认为是真实的)。

POW机制：某时刻只能有一个人完成签名；每个签名的人需要付出一定的计算力(捣乱的人如果签名会消耗成本)。

#### 比特币交易

共计2100万，区块大小上线是1MB。

所有的节点如何对某个账本（当前交易的账本）达成共识。比特币是账本上的一个数字，区块链是记录各种交易数据的数组账本，比特币流通中产生的区块链账本（技术概念）。

交易的简化流程：A给B转账，转账的信息在分布式网络中广播，网络通过计算区块验证是否是真实的交易(A是否真实拥有这个数字货币)，然后把计算结果分布式发广播出去，然后把交易记录写入账本中。区块就是一个账单，区块链就是一个账本(账单前后交易加起来的账单)。实际上是链式结构，后面的账本的哈希值指向前面的哈希值。区块链类似一个密码学协议，比特币是区块链在金融方面的应用。

#### 比特币主要技术

1. 哈希算法：一个固定长度的输出值，可以把任何一个字符串转化成一个16位的值，不会冲突

2. 加密技术：对称加密和非对称加密。非对称加密（RSA加密算法、椭圆曲线算法）：公钥和私钥，公钥用于加密，私钥用于签名。数字签名(CA)。在一次通话中，首先使用非对称加密最安全，双方使用非对称加密将密钥协商一致，之后使用对称加密进行传输。比特币是非对称加密：随机产生一个私钥数字（密码），通过椭圆曲线算法产生一个公钥，通过哈希算法从公钥产生一个比特币地址(账户)。转账需要提供比特币地址账户即可。产生公钥和产生比特币地址的过程是单向的。比特币在交易过程中会记录交易者的地址，一部分其他门罗币等不会记录交易者的地址(隐藏性更大)。
3. P2P：pear to pear 点对点；每个人是服务器和客户端；类似于迅雷的P2P加速。现在很多P2P已经暴雷了。
4. 默克尔树(二叉树)：默克尔树(Hash tree)存储哈希的一棵树，叶节点是数据块的hash值，是平衡二叉树。上面的树干是下面哈希值生成的，树的根节点放在区块的头，用于快速遍历，提高效率。 
5. 双花问题(double-spending)：最长链机制，等新的区块6个写入后完成之前的交易。

#### 代码结构

区块头+区块体(类似于HTTP中的请求头和请求体)  包含上一个区块的哈希值，当前区块的默克尔树的根节点的哈希值，当前的时间戳，当前区块计算的难度，还有一个随机值(便于区分同一时间内产生的区块)。一个区块不存放当前区块的哈希值，同步数据后，独立计算哈希值并存储到本地的数据库。 区块体：存放区块的交易记录。

可以通过区块的哈希或者高度(数组的长度)确定区块。如果同时两个区块产生，他们的高度一致(概率很小)，那么区块链会分叉。下一个区块出现在哪个分支后面，那么这个分支就是区块链的主链(人们认可这个链)。

Blockchail.info 查询当前区块的高度和信息 

#### 交易过程

A向B用户转账：A通过P2P方式在网络上广播自己和B的交易，然后不同节点验证A是否有权进行交易(是否账户存在等)，全网开始区块碰撞(挖矿)，进行十分钟的计算比赛。如果某个节点计算出下一个区块，立刻广播到全网，其他节点检验这个节点计算的结果是否正确，如果计算的结果是正确的，那么这个节点具有记账的权利，将这笔交易记录在这个节点中，那么A和B的交易完成，同时计算的这个节点奖励新的比特币。

#### 存在问题

51% 算力攻击：主要的算力被大型矿池集中，可以改账本，那么可以频繁的花自己的钱后完成记账(自己的钱不能被消费，其他的账户不能控制)；

图灵不完备：无循环计算，复杂引用无法胜任

区块太小：1MB



### 区块链

区块链现在是一个协议，按照这个设计思路设计的产品(产品溯源)，实际上就是一个token，用在金融上就是比特币等数字货币。

特点：去中心化、不可伪造、不可篡改、不可复制、匿名、密码学、分布式、可溯源、账本公开。

分类：公有链（比特币、以太坊等公开的链）+联盟链（全球银行联盟）+私有链（企业内部的区块链）

#### 区块链常用概念

算力：计算机计算的能力

矿工：算力很高的节点，主要挖矿

矿机：单个挖矿计算机

矿场：若干矿机构成一个矿场

矿池：若干矿场和矿机构成一个矿池。矿池获取计算任务后，把任务分配到不同的矿场和矿机上进行挖矿。现在大部分的币都是矿池挖出的。

分叉：扩容会分叉（比特币）、智能合约漏洞（代码升级时不同社区意见发生分歧造成分歧）。软分叉+硬分叉。如那分叉是新老合约一条链，硬分叉是新旧完全分裂（ETC-ETH），分成两个独立的币种。

POW：proof of work: 工作量证明，计算哈希值的过程(比特币被主流矿池垄断，电费浪费严重，噪声严重，普通人难以参与，算力决定一切)

共识机制：不同的数字货币具有不同的公式机制（HSR）李笑来是比特币皇帝

智能合约：合同数字化，合约会按照第三方或者其他信息执行（类似于支付宝，钱先放在支付宝上面）。精髓支出：触发支付，合同双方不能违背合约。

UTXO：未经花费的交易 unspent transaction output 。比特币没有账户余额的概念；钱包会用私钥尝试解开区块，从数量上进一步算出现在的价值。一个用户拥有UTXO，交易过程中，将这个UTXO销毁，产生一个新的UTXO。UTXO 会记录在UTXO池中，交易发生时，一个用户会从池中获取自己的UTXO，然后交易(原来有3+6, 现在产生8+1，支付8剩余1，剩余1的UTXO和之前的不同)每次交易前需要遍历UTXO池。

钱包：把私钥和公钥保管在一个软件或者硬件（U盾）等设备中

纸钱包：把公钥和私钥的二维码做到实际的纸上的钱包，扫描二维码即可使用。

